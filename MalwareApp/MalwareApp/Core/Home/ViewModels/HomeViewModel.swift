//
//  HomeViewModel.swift
//  MalwareApp
//
//  Created by Ernest Gaisie on 10/02/2025.
//

import Foundation
import Combine

class HomeViewModel: ObservableObject {
    @Published var allStatuses: [StatusModel] = []
    @Published var isLoading: Bool = false
    @Published var errorMessage: String? = nil
    @Published var lastScanDate: String = "never"

    
    private let dataService = StatusDataService()
    private var cancellables = Set<AnyCancellable>()
    
    init(){
        self.isLoading = true
        addSubscribers()
    }
    
    func addSubscribers() {
        dataService.$allStatuses
            .sink { [weak self] (returnedStatuses) in
                self?.isLoading = false
                self?.errorMessage = nil
                self?.allStatuses = returnedStatuses
                self?.updateLastScanDate()
            }
            .store(in: &cancellables)
        
        dataService.$errorMessage
            .sink { [weak self] error in
                self?.errorMessage = error
            }
            .store(in: &cancellables)
    }
    
    func reloadData() {
        print("Scan tapped")
        isLoading = true
        allStatuses.removeAll() 
        dataService.getStatuses()
    }
    
    private func updateLastScanDate() {
        let formatter = DateFormatter()
        formatter.dateFormat = "dd.MM.yyyy HH:mm" // Matches 23.02.2025 12:34 format
        lastScanDate = "Last scan - \(formatter.string(from: Date()))"
    }
}
